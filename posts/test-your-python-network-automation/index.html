<!DOCTYPE html><html lang="en" data-mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Test your network automation with Pytest &amp; Mock" /><meta property="og:locale" content="en" /><meta name="description" content="Recently, we have been challenged on how we could test our ansible-cvp development to make sure changes are not breaking the code." /><meta property="og:description" content="Recently, we have been challenged on how we could test our ansible-cvp development to make sure changes are not breaking the code." /><link rel="canonical" href="https://www.inetsix.net/posts/test-your-python-network-automation/" /><meta property="og:url" content="https://www.inetsix.net/posts/test-your-python-network-automation/" /><meta property="og:site_name" content="Networking Games" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-02-18T09:46:00+01:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Test your network automation with Pytest &amp; Mock" /><meta name="twitter:site" content="@titom73" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-02-18T09:46:00+01:00","datePublished":"2022-02-18T09:46:00+01:00","description":"Recently, we have been challenged on how we could test our ansible-cvp development to make sure changes are not breaking the code.","headline":"Test your network automation with Pytest &amp; Mock","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.inetsix.net/posts/test-your-python-network-automation/"},"url":"https://www.inetsix.net/posts/test-your-python-network-automation/"}</script><title>Test your network automation with Pytest & Mock | Networking Games</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Networking Games"><meta name="application-name" content="Networking Games"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end" lang="en"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/avatar.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Networking Games</a></div><div class="site-subtitle font-italic">Switch, route and firewall packets but never at line-rate</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/titom73" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/titom73" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['tom','inetsix.net'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Test your network automation with Pytest & Mock</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Test your network automation with Pytest & Mock</h1><div class="post-meta text-muted"><div> By <em> <a href="https://twitter.com/titom73">Thomas Grimonet</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" data-ts="1645173960" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2022-02-18 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1396 words"> <em>7 min</em> read</span></div></div></div><div class="post-content"><p>Recently, we have been challenged on how we could test our <a href="https://github.com/aristanetworks/ansible-cvp">ansible-cvp</a> development to make sure changes are not breaking the code.</p><p>One of the solution would be to build a test topology we can access from our CI and use it to run ansible content to validate. Regardless the security aspect of such topology, we thought it is not efficient: if your code is broken, you will eat an ansible error message and not a pointer to the python code.</p><p>So we decided to take the well known software approach: <a href="https://docs.pytest.org/en/7.0.x/">pytest to run unit &amp; system tests</a>. And to use it with no <a href="https://www.arista.com/en/products/eos/eos-cloudvision">Cloudvision</a> nor EOS devices, we put <a href="https://docs.python.org/3/library/unittest.mock.html">Mock</a> in place to emulate API endpoint.</p><p><img data-src="/assets/img/test-your-python-network-automation/pytest-mocking.png" alt="" data-proofer-ignore></p><p>In this article, we will go through the process we put in place to support ansible-cvp development and go through some basic examples.</p><h2 id="create-a-mock-of-cvprac--cvp">Create a mock of CVPRAC / CVP <a href="#create-a-mock-of-cvprac--cvp" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><p>Since <code class="language-plaintext highlighter-rouge">arista.cvp</code> collection is in charge of communicating with Cloudvision, we need to emulate it in our testing. So the mock will recreate all cvprac function and use static data coming from CV.</p><p>So first of all, we need to load <a href="https://docs.python.org/3/library/unittest.mock.html">MagicMock</a> and <a href="https://github.com/aristanetworks/cvprac">cvprac</a> libraries</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="kn">from</span> <span class="nn">unittest.mock</span> <span class="kn">import</span> <span class="n">MagicMock</span><span class="p">,</span> <span class="n">create_autospec</span>
<span class="kn">import</span> <span class="nn">pprint</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">cvprac.cvp_client</span> <span class="kn">import</span> <span class="n">CvpClient</span><span class="p">,</span> <span class="n">CvpApi</span>
</pre></table></code></div></div><p>Now we can create a Mock from <a href="https://realpython.com/python-mock-library/">MagickMock</a>. This approach gives us option to create side_effects to define how function should work.</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">get_cvp_client</span><span class="p">(</span><span class="n">cvp_database</span><span class="p">:</span>  <span class="n">MockCVPDatabase</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MagicMock</span><span class="p">:</span>
    <span class="c1"># Instantiate a Mock from CvpClient to support authentication process
</span>    <span class="n">mock_client</span> <span class="o">=</span> <span class="n">create_autospec</span><span class="p">(</span><span class="n">CvpClient</span><span class="p">)</span>

    <span class="c1"># Instantiate a Mock from CvpApi to support CVP interaction
</span>    <span class="n">mock_client</span><span class="p">.</span><span class="n">api</span> <span class="o">=</span> <span class="n">create_autospec</span><span class="p">(</span><span class="n">CvpApi</span><span class="p">)</span>

    <span class="c1"># Create side_effects to expose cvprac methods
</span>    <span class="n">mock_client</span><span class="p">.</span><span class="n">api</span><span class="p">.</span><span class="n">get_configlets_and_mappers</span><span class="p">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">cvp_database</span><span class="p">.</span><span class="n">get_configlets_and_mappers</span>

    <span class="c1"># Expose created MOCK
</span>    <span class="k">return</span> <span class="n">mock_client</span>
</pre></table></code></div></div><p>As you can see in the <a href="https://docs.python.org/3/library/unittest.mock.html#unittest.mock.Mock.side_effect"><code class="language-plaintext highlighter-rouge">side_effects</code></a> definition, we use cvprac method name as it is automatically populated from the <a href="https://docs.python.org/3/library/unittest.mock.html#create-autospec"><code class="language-plaintext highlighter-rouge">create_autospec</code></a>. In our case, we have an object named <code class="language-plaintext highlighter-rouge">cvp_database</code> where we have all the cvprac method we use. Main reason is this object can instantiate a fake database with user’s defined JSON object. <a href="https://docs.python.org/3/library/unittest.mock.html#autospeccing">Auospeccing</a> also add security guard to recursively speccing attributes and avoid silent error that could break CI.</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">MockCVPDatabase</span><span class="p">:</span>
    <span class="s">"""Class to mock CVP database being modified during tests"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">configlets_mappers</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">configlets_mappers</span> <span class="o">=</span> <span class="n">configlets_mappers</span> <span class="k">if</span> <span class="n">configlets_mappers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="p">{}</span>
</pre></table></code></div></div><blockquote><p>This code is not a complete one as it can be a bit too long.</p></blockquote><p>And now we have to create our side_effects method. In our example, we will do a side_effect for get_containers method</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">MockCVPDatabase</span><span class="p">:</span>
    <span class="s">"""Class to mock CVP database being modified during tests"""</span>
    <span class="k">def</span> <span class="nf">get_configlets_and_mappers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""
        get_configlets_and_mappers Return Mapping for configlets
        """</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">configlets_mappers</span>
</pre></table></code></div></div><p>This function exposes data as cvprac would do if it has some real CV connection. So to build this function, you need to define what your JSON structure will be in your MOCK and data structure sent back by cvprac. So in this example, we use the following structure:</p><div class="language-json highlighter-rouge"><div class="code-header"> <span data-label-text="JSON"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre><td class="rouge-code"><pre><span class="p">{</span><span class="w">
    </span><span class="nl">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"configlets"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
            </span><span class="p">{</span><span class="w">
                </span><span class="nl">"key"</span><span class="p">:</span><span class="w"> </span><span class="s2">"configlet_0b5f1972-bb04-4d31-931d-baf7061caa13"</span><span class="p">,</span><span class="w">
                </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"spine-2-unit-test"</span><span class="p">,</span><span class="w">
                </span><span class="nl">"reconciled"</span><span class="p">:</span><span class="w"> </span><span class="s2">"false"</span><span class="p">,</span><span class="w">
                </span><span class="nl">"configl"</span><span class="p">:</span><span class="w"> </span><span class="s2">"alias mock show ip route"</span><span class="p">,</span><span class="w">
                </span><span class="nl">"user"</span><span class="p">:</span><span class="w"> </span><span class="s2">"cvpadmin"</span><span class="p">,</span><span class="w">
                </span><span class="nl">"note"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">
                </span><span class="nl">"containerCount"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
                </span><span class="nl">"netElementCount"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
                </span><span class="nl">"dateTimeInLongFormat"</span><span class="p">:</span><span class="w"> </span><span class="mi">1640858616983</span><span class="p">,</span><span class="w">
                </span><span class="nl">"isDefault"</span><span class="p">:</span><span class="w"> </span><span class="s2">"no"</span><span class="p">,</span><span class="w">
                </span><span class="nl">"isAutoBuilder"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">
                </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Static"</span><span class="p">,</span><span class="w">
                </span><span class="nl">"editable"</span><span class="p">:</span><span class="w"> </span><span class="s2">"true"</span><span class="p">,</span><span class="w">
                </span><span class="nl">"sslConfig"</span><span class="p">:</span><span class="w"> </span><span class="s2">"false"</span><span class="p">,</span><span class="w">
                </span><span class="nl">"visible"</span><span class="p">:</span><span class="w"> </span><span class="s2">"true"</span><span class="p">,</span><span class="w">
                </span><span class="nl">"isDraft"</span><span class="p">:</span><span class="w"> </span><span class="s2">"false"</span><span class="p">,</span><span class="w">
                </span><span class="nl">"typeStudioConfiglet"</span><span class="p">:</span><span class="w"> </span><span class="s2">"false"</span><span class="w">
            </span><span class="p">},</span><span class="w">
            </span><span class="err">//</span><span class="p">[</span><span class="err">...</span><span class="p">]</span><span class="w">
        </span><span class="p">]</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><blockquote><p>This output is basically what CV provides when you GET configlet_mappers with curl:</p></blockquote><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>curl <span class="nt">-X</span> <span class="s1">'GET'</span> <span class="se">\</span>
  <span class="s1">'https://&lt;cv-ip-address&gt;/cvpservice/configlet/\
    getConfigletsAndAssociatedMappers.do'</span> <span class="se">\</span>
    <span class="nt">-H</span> <span class="s1">'accept: application/json'</span>
</pre></table></code></div></div><p>Everything seems cool, but how can we use it with Pytest and build relevant test cases ?</p><h2 id="configure-pytest">Configure Pytest <a href="#configure-pytest" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><h3 id="create-fixture-to-instantiate-db">Create fixture to instantiate DB <a href="#create-fixture-to-instantiate-db" class="anchor"><i class="fas fa-hashtag"></i></a></h3></h3><p>Let’s consider writing tests for <a href="https://github.com/aristanetworks/ansible-cvp/blob/devel/ansible_collections/arista/cvp/plugins/module_utils/facts_tools.py"><code class="language-plaintext highlighter-rouge">cv_facts_v3</code></a> as it is a fairly easy one.</p><p>Let’s create a <a href="https://docs.pytest.org/en/7.0.x/explanation/fixtures.html?highlight=fixture"><strong>fixture</strong></a> to instantiate environment each time we run a test. This fixture creates an object named <code class="language-plaintext highlighter-rouge">database</code> from <code class="language-plaintext highlighter-rouge">mock.MockCVPDatabase</code> and uses data from test environment.</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre><span class="c1">#!/usr/bin/python
# coding: utf-8 -*-
</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="p">(</span><span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">pytest</span>
<span class="kn">from</span> <span class="nn">tests.lib</span> <span class="kn">import</span> <span class="n">mock</span><span class="p">,</span> <span class="n">mock_ansible</span>
<span class="kn">from</span> <span class="nn">tests.data</span> <span class="kn">import</span> <span class="n">facts_unit</span>
<span class="kn">from</span> <span class="nn">ansible_collections.arista.cvp.plugins.module_utils.facts_tools</span> <span class="kn">import</span> <span class="n">CvFactsTools</span>

<span class="n">LOGGER</span> <span class="o">=</span> <span class="n">setup_custom_logger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="o">@</span><span class="n">pytest</span><span class="p">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">cvp_database</span><span class="p">():</span>
    <span class="n">database</span> <span class="o">=</span> <span class="n">mock</span><span class="p">.</span><span class="n">MockCVPDatabase</span><span class="p">(</span>
        <span class="n">devices</span><span class="o">=</span><span class="n">facts_unit</span><span class="p">.</span><span class="n">MOCKDATA_DEVICES</span><span class="p">,</span>
        <span class="n">configlets</span><span class="o">=</span><span class="n">facts_unit</span><span class="p">.</span><span class="n">MOCKDATA_CONFIGLETS</span><span class="p">,</span>
        <span class="n">containers</span><span class="o">=</span><span class="n">facts_unit</span><span class="p">.</span><span class="n">MOCKDATA_CONTAINERS</span><span class="p">,</span>
        <span class="n">configlets_mappers</span><span class="o">=</span><span class="n">facts_unit</span><span class="p">.</span><span class="n">MOCKDATA_CONFIGLET_MAPPERS</span>
    <span class="p">)</span>
    <span class="k">yield</span> <span class="n">database</span>
    <span class="n">LOGGER</span><span class="p">.</span><span class="n">debug</span><span class="p">(</span><span class="s">'Final CVP state: %s'</span><span class="p">,</span> <span class="n">database</span><span class="p">)</span>
</pre></table></code></div></div><p>This approach is based on a generic content available for all cases. But another approach can be to leverage indirect parametrisation to inject data specific to each test. We won’t go through each approach here since both presents pro and cons. But if you want to read more, you can refer to <a href="https://docs.pytest.org/en/6.2.x/example/parametrize.html#indirect-parametrization">this page</a>.</p><p>Another fixture is used to instantiate <code class="language-plaintext highlighter-rouge">arista.cvp</code> utils and is based on the same approach:</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="o">@</span><span class="n">pytest</span><span class="p">.</span><span class="n">fixture</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">fact_unit_tools</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">cvp_database</span><span class="p">):</span>
    <span class="n">cvp_client</span> <span class="o">=</span> <span class="n">mock</span><span class="p">.</span><span class="n">get_cvp_client</span><span class="p">(</span><span class="n">cvp_database</span><span class="p">)</span>
    <span class="n">instance</span> <span class="o">=</span> <span class="n">CvFactsTools</span><span class="p">(</span><span class="n">cv_connection</span><span class="o">=</span><span class="n">cvp_client</span><span class="p">)</span>
    <span class="n">LOGGER</span><span class="p">.</span><span class="n">debug</span><span class="p">(</span><span class="s">'Initial CVP state: %s'</span><span class="p">,</span> <span class="n">cvp_database</span><span class="p">)</span>
    <span class="k">yield</span> <span class="n">instance</span>
    <span class="n">LOGGER</span><span class="p">.</span><span class="n">debug</span><span class="p">(</span><span class="s">'Mock calls: %s'</span><span class="p">,</span> <span class="n">pprint</span><span class="p">.</span><span class="n">pformat</span><span class="p">(</span><span class="n">cvp_client</span><span class="p">.</span><span class="n">mock_calls</span><span class="p">))</span>
</pre></table></code></div></div><p>As you can see in example above, we log state when we instantiate and release data in fixture. So we can see changes in Cloudvision database and inspect result of tests anytime. Also, <code class="language-plaintext highlighter-rouge">yield</code> is header of code runs when we release code after test execution.</p><h3 id="parametrize-tests">Parametrize tests <a href="#parametrize-tests" class="anchor"><i class="fas fa-hashtag"></i></a></h3></h3><p>Pytest aims to create a test we can run against different dataset. These dataset can be pass to the method by using what we call <a href="https://docs.pytest.org/en/7.0.x/example/parametrize.html?highlight=parametrize"><strong>parametrize</strong></a>. In our situation, we use same data we loaded in our fixture so it is easy to validate results.</p><p>In our example, <code class="language-plaintext highlighter-rouge">facts_unit.MOCKDATA_DEVICES</code> is a list, so we do not have to call a method to transform and pytest will iterate to generate 1 test case per entry. Also by default, name for tests genrated by Pytest will have no sense. So we use a function to generate IDs automatically</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">generate_test_ids_dict</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
    <span class="k">if</span> <span class="s">'name'</span> <span class="ow">in</span> <span class="n">val</span><span class="p">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="c1"># note this wouldn't show any hours/minutes/seconds
</span>        <span class="k">return</span> <span class="n">val</span><span class="p">[</span><span class="s">'name'</span><span class="p">]</span>
    <span class="k">elif</span> <span class="s">'hostname'</span> <span class="ow">in</span> <span class="n">val</span><span class="p">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">val</span><span class="p">[</span><span class="s">'hostname'</span><span class="p">]</span>

<span class="o">@</span><span class="n">pytest</span><span class="p">.</span><span class="n">mark</span><span class="p">.</span><span class="n">parametrize</span>
<span class="p">(</span>
    <span class="s">"device_def"</span><span class="p">,</span>
    <span class="n">facts_unit</span><span class="p">.</span><span class="n">MOCKDATA_DEVICES</span><span class="p">,</span>
    <span class="n">ids</span><span class="o">=</span><span class="n">generate_test_ids_dict</span>
<span class="p">)</span>
</pre></table></code></div></div><h3 id="build-a-test-case">build a test case <a href="#build-a-test-case" class="anchor"><i class="fas fa-hashtag"></i></a></h3></h3><p>So now we are ready to build a test with all these elements:</p><ul><li>Use fixture to instantiate DB.<li>Use fixture to instantiate a module utils.<li>Use a parametrize to increase test examples.</ul><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre><td class="rouge-code"><pre><span class="o">@</span><span class="n">pytest</span><span class="p">.</span><span class="n">mark</span><span class="p">.</span><span class="n">usefixtures</span><span class="p">(</span><span class="s">"fact_unit_tools"</span><span class="p">)</span>
<span class="o">@</span><span class="n">pytest</span><span class="p">.</span><span class="n">mark</span><span class="p">.</span><span class="n">usefixtures</span><span class="p">(</span><span class="s">"cvp_database"</span><span class="p">)</span>
<span class="o">@</span><span class="n">pytest</span><span class="p">.</span><span class="n">mark</span><span class="p">.</span><span class="n">parametrize</span>
<span class="p">(</span>
    <span class="s">"device_def"</span><span class="p">,</span>
    <span class="n">facts_unit</span><span class="p">.</span><span class="n">MOCKDATA_DEVICES</span><span class="p">,</span>
    <span class="n">ids</span><span class="o">=</span><span class="n">generate_test_ids_dict</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_CvFactsTools__device_get_configlets_with_configlets</span>
<span class="p">(</span>
    <span class="n">fact_unit_tools</span><span class="p">,</span>
    <span class="n">device_def</span>
<span class="p">):</span>
    <span class="c1"># Only target devices that have configlets configured.
</span>
    <span class="c1"># Run command to get configlet for device on Cloudvision
</span>    <span class="n">result</span> <span class="o">=</span> <span class="n">fact_unit_tools</span><span class="p">.</span><span class="n">_CvFactsTools__device_get_configlets</span><span class="p">(</span>
        <span class="n">netid</span><span class="o">=</span><span class="n">device_def</span><span class="p">[</span><span class="s">'systemMacAddress'</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="c1"># If we can get the device in the input data (i.e. not from cloudvision),
</span>    <span class="c1"># we can play with assert
</span>    <span class="k">if</span> <span class="n">device_def</span><span class="p">[</span><span class="s">'systemMacAddress'</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="s">'objectId'</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">facts_unit</span><span class="p">.</span><span class="n">MOCKDATA_CONFIGLET_MAPPERS</span><span class="p">[</span><span class="s">'data'</span><span class="p">][</span><span class="s">'configletMappers'</span><span class="p">]]:</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># If not covered by test (i.e. has no configlet attached), we simply skip it
</span>        <span class="n">pytest</span><span class="p">.</span><span class="n">skip</span><span class="p">(</span><span class="s">"skipping DEVICES with no configlet"</span><span class="p">)</span>
</pre></table></code></div></div><p>This example run a method to ask for all configlets for the device and then read the database to compare result with what the method provided.</p><p>Because <code class="language-plaintext highlighter-rouge">fact_unit_tools</code> has been provisioned with a cvp_client based on our mock, the function <code class="language-plaintext highlighter-rouge">__device_get_configlets</code> is getting data based on the correct CVP format and well formated by the mock of CVPRAC with <code class="language-plaintext highlighter-rouge">get_configlets_and_mappers</code> method.</p><h2 id="run-testing">Run testing <a href="#run-testing" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><p>Execute testing is fairly easy and use basic pytest CLI commands. You don’t have to build a lab somewhere to run unit test of your automation. So CI can catch very quickly any deviation as you can write test for any single method or object you have in your code.</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="n">pytest</span> \
    <span class="o">-</span><span class="n">rA</span> <span class="o">-</span><span class="n">q</span> <span class="o">--</span><span class="n">cov</span><span class="o">-</span><span class="n">report</span> <span class="n">term</span><span class="p">:</span><span class="n">skip</span><span class="o">-</span><span class="n">covered</span> \
    <span class="o">-</span><span class="n">v</span> <span class="o">--</span><span class="n">html</span><span class="o">=</span><span class="n">report</span><span class="p">.</span><span class="n">html</span> <span class="o">--</span><span class="bp">self</span><span class="o">-</span><span class="n">contained</span><span class="o">-</span><span class="n">html</span> <span class="o">--</span><span class="n">cov</span><span class="o">-</span><span class="n">report</span><span class="o">=</span><span class="n">html</span> \
    <span class="o">--</span><span class="n">color</span> <span class="n">yes</span> \
    <span class="o">--</span><span class="n">cov</span><span class="o">=</span><span class="n">ansible_collections</span><span class="p">.</span><span class="n">arista</span><span class="p">.</span><span class="n">cvp</span><span class="p">.</span><span class="n">plugins</span><span class="p">.</span><span class="n">module_utils</span> \
    <span class="o">--</span><span class="n">log</span><span class="o">-</span><span class="n">cli</span><span class="o">-</span><span class="n">level</span><span class="o">=</span><span class="n">INFO</span> <span class="o">-</span><span class="n">m</span> <span class="s">'image'</span> <span class="n">unit</span><span class="o">/</span>
</pre></table></code></div></div><p>In our case, we can easily test our ansible modules functions before starting to play with ansible. And in reality we do unit test with Pytest &amp; Mock, integration tests with Pytest and CV and finally we can do manual or leverage Molecule to test from Ansible</p><p>and a big shout out to the whole ansible-cvp development team: <a href="https://github.com/noredistribution">Tamas</a>, <a href="https://github.com/guillaumeVilar">Guillaume</a>, <a href="https://github.com/mtache">Matthieu</a> for ideas, brainstorming, testing, and implementation.</p><h2 id="resources">Resources <a href="#resources" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><ul><li><a href="https://docs.pytest.org/en/7.0.x/">Pytest</a><li><a href="https://docs.python.org/3/library/unittest.mock.html">unittest.mock</a> for Pytest<li>What is a Pytest <a href="https://docs.pytest.org/en/7.0.x/explanation/fixtures.html?highlight=fixture">Fixture</a><li><a href="https://docs.pytest.org/en/7.0.x/example/parametrize.html?highlight=parametrize">Parametrizing Tests</a></ul></div><div class="post-tail-wrapper text-muted"><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Test your network automation with Pytest &amp; Mock - Networking Games&amp;url=https://www.inetsix.net/posts/test-your-python-network-automation/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Test your network automation with Pytest &amp; Mock - Networking Games&amp;u=https://www.inetsix.net/posts/test-your-python-network-automation/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https://www.inetsix.net/posts/test-your-python-network-automation/&amp;text=Test your network automation with Pytest &amp; Mock - Networking Games" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/avd-with-containerlab/">Build Containerlab topology from AVD</a><li><a href="/posts/Ansible-AWX-EE/">Deploy & Configure AWX with Ansible EE</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/ansible/">ansible</a> <a class="post-tag" href="/tags/arista/">arista</a> <a class="post-tag" href="/tags/devops/">devops</a> <a class="post-tag" href="/tags/awx/">awx</a> <a class="post-tag" href="/tags/containerlab/">containerlab</a> <a class="post-tag" href="/tags/python/">python</a> <a class="post-tag" href="/tags/security/">security</a> <a class="post-tag" href="/tags/shell/">shell</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/Ansible-vault-1password/"><div class="card-body"> <em class="timeago small" data-ts="1648504800" > 2022-03-29 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Ansible VAULT with 1password</h3><div class="text-muted small"><p> Ansible provides a tool to protect sensitive data in inventories and makes them unusable without encryption password. Documentation for ansible-vault is pretty nice and very helpful, but at some p...</p></div></div></a></div><div class="card"> <a href="/posts/avd-with-containerlab/"><div class="card-body"> <em class="timeago small" data-ts="1643983740" > 2022-02-04 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Build Containerlab topology from AVD</h3><div class="text-muted small"><p> Overview Until recently, if we want to do networking lab, we had option to play with GNS3 or EVE-NG with Virtual Machine for Network OS. But 2021 has seen the rise of Containerlab which gives us a...</p></div></div></a></div><div class="card"> <a href="/posts/Ansible-AWX-EE/"><div class="card-body"> <em class="timeago small" data-ts="1643842800" > 2022-02-03 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Deploy & Configure AWX with Ansible EE</h3><div class="text-muted small"><p> About This example shows how to deploy basic EVPN/VXLAN Fabric based on Arista Validated Design roles using Ansible Tower/AWX. This repository will be used as project on AWX and we will describe h...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/avd-with-containerlab/" class="btn btn-outline-primary" prompt="Older"><p>Build Containerlab topology from AVD</p></a> <a href="/posts/Ansible-vault-1password/" class="btn btn-outline-primary" prompt="Newer"><p>Ansible VAULT with 1password</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/titom73">Thomas Grimonet</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/ansible/">ansible</a> <a class="post-tag" href="/tags/arista/">arista</a> <a class="post-tag" href="/tags/devops/">devops</a> <a class="post-tag" href="/tags/awx/">awx</a> <a class="post-tag" href="/tags/containerlab/">containerlab</a> <a class="post-tag" href="/tags/python/">python</a> <a class="post-tag" href="/tags/security/">security</a> <a class="post-tag" href="/tags/shell/">shell</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-NJM955PBFN"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-NJM955PBFN'); }); </script>
